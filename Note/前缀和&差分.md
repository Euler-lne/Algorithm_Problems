# 前缀和&差分

好的，这是一个非常核心且实用的算法技巧问题。差分和前綴和（你提到的“前序和”通常称为“前缀和”）是一对互逆的操作，它们的思想截然相反，用于解决不同类型的问题。

下面我将详细解释它们的区别、联系以及各自的应用场景。

### 核心概念与思想对比

| 特性         | 前缀和                                                                                                     | 差分                                                                                                       |
| :----------- | :--------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------- |
| **核心思想** | **“以空间换时间”**，预处理一个数组，使得每个位置存储的是原数组从起始位置到当前位置的累计和。               | **“以时间换空间”**，构建一个数组，用于表示原数组中相邻元素的差值。                                         |
| **定义**     | 对于一个原数组 `a[1...n]`，其前缀和数组 `S[i]` 定义为：`S[i] = a[1] + a[2] + ... + a[i]`。                 | 对于一个原数组 `a[1...n]`，其差分数组 `d[i]` 定义为：`d[1] = a[1]`, `d[i] = a[i] - a[i-1]` (对于 i > 1)。  |
| **构建目的** | **快速计算区间和**。                                                                                       | **快速进行区间修改**。                                                                                     |
| **操作速度** | **查询快，修改慢**。<br>• 构建：O(n)<br>• **区间查询：O(1)** <br>• 单点修改：O(n) (需要更新后续所有前缀和) | **修改快，查询慢**。<br>• 构建：O(n)<br>• **区间修改：O(1)** <br>• 单点查询：O(n) (需要从开头累加差分数组) |
| **相互关系** | **差分是前缀和的逆运算**。对原数组 `a` 求前缀和得到 `S`，对 `S` 求差分得到 `a`。反之亦然。                 | **前缀和是差分的逆运算**。对原数组 `a` 求差分得到 `d`，对 `d` 求前缀和得到 `a`。                           |

---

### 深入解析与示例

#### 1. 前缀和

**核心用途：快速计算任意区间和。**

**工作原理：**
假设原数组为 `a = [a1, a2, a3, ..., an]`，我们预处理一个前缀和数组 `S`：
- `S[0] = 0` (一个常见的技巧，可以简化边界处理)
- `S[1] = a1`
- `S[2] = a1 + a2`
- `S[3] = a1 + a2 + a3`
- ...
- `S[i] = S[i-1] + a[i]`

那么，要计算原数组从 `l` 到 `r` 的区间和，只需要：
`sum(l, r) = S[r] - S[l-1]`

**示例：**
`a = [1, 3, 2, 5, 7]`
`S = [0, 1, 4, 6, 11, 18]` (第一个是S[0]=0)

计算 `a[2] + a[3] + a[4]`，即 `l=2, r=4`：
- 原始方法：3 + 2 + 5 = 10
- 前缀和方法：`S[4] - S[1] = 11 - 1 = 10`

**何时使用前缀和？**
当问题中**频繁进行区间和的查询**，而数组本身**不经常修改**时，使用前缀和是最高效的。
- **典型场景**：给定一个静态数组，进行数万次甚至数百万次“求某个子数组的和”的查询。

#### 2. 差分

**核心用途：快速对任意区间进行增减操作。**

**工作原理：**
假设原数组为 `a = [a1, a2, a3, ..., an]`，我们构建一个差分数组 `d`：
- `d[1] = a1`
- `d[2] = a2 - a1`
- `d[3] = a3 - a2`
- ...
- `d[i] = a[i] - a[i-1]`

差分数组的妙处在于：**对原数组 `a` 的区间 `[l, r]` 同时增加一个值 `k`，等价于在其差分数组 `d` 上进行两次单点修改**：
1. `d[l] = d[l] + k`
2. `d[r+1] = d[r+1] - k` (如果 r+1 在数组范围内)

完成所有区间修改操作后，我们**对差分数组 `d` 求一次前缀和**，就可以得到修改后的原数组 `a‘`。

**示例：**
初始数组 `a = [1, 3, 2, 5, 7]`
差分数组 `d = [1, 2, -1, 3, 2]`

现在，我们想让 `a[2]` 到 `a[4]` 的每个元素都加上 `4`，即 `l=2, r=4, k=4`。
1. 在差分数组 `d` 上操作：
   - `d[2] = d[2] + 4` -> `d[2]` 从 2 变成 6。
   - `d[5] = d[5] - 4` -> `d[5]` 从 2 变成 -2。
   - 新的差分数组 `d' = [1, 6, -1, 3, -2]`

2. 对新的 `d‘` 求前缀和，得到新的原数组 `a’`：
   - `a‘[1] = d’[1] = 1`
   - `a‘[2] = a’[1] + d‘[2] = 1 + 6 = 7`
   - `a‘[3] = a’[2] + d‘[3] = 7 + (-1) = 6`
   - `a‘[4] = a’[3] + d‘[4] = 6 + 3 = 9`
   - `a‘[5] = a’[4] + d‘[5] = 9 + (-2) = 7`
   - 最终 `a’ = [1, 7, 6, 9, 7]`，验证一下，`[3,2,5]` 每个加4后确实是 `[7,6,9]`。

**何时使用差分？**
当问题中**频繁对数组的某个区间进行统一的加减操作**，而最后只需要查询最终结果时，使用差分是最高效的。
- **典型场景**：预定系统（如会议室、航班座位），在某个时间段内进行多次预定（区间修改），最后问每个时间点的预定数（单点查询）。或者像“区间加法”这样的算法题。

---

### 总结与关键区别

| 方面             | 前缀和                                                                 | 差分                                                                                  |
| :--------------- | :--------------------------------------------------------------------- | :------------------------------------------------------------------------------------ |
| **要解决的问题** | **“查询区间和”**                                                       | **“修改区间值”**                                                                      |
| **核心操作**     | `S[r] - S[l-1]`                                                        | `d[l] += k; d[r+1] -= k;`                                                             |
| **最终结果获取** | 直接使用前缀和数组计算                                                 | 需要对差分数组**求前缀和**来还原原数组                                                |
| **比喻**         | **银行的流水账单**。想知道某个月花了多少钱，用月底余额减月初余额即可。 | **批量转账指令**。发一条指令“给第2到第4个人每人转4元”，系统只记录指令，最后统一结算。 |

### 如何选择？

1.  **问自己：我的问题是查询多还是修改多？**
    -   如果主要是**查询区间和**，而数组基本不变 -> **用前缀和**。
    -   如果主要是**对区间进行增减**，最后才需要结果 -> **用差分**。

2.  **进阶技巧：结合使用**
    在一些复杂问题中，差分和前缀和可能会结合使用，或者需要嵌套数据结构（如树状数组、线段树）来同时支持高效的区间修改和区间查询。但对于理解基础思想，掌握这两者至关重要。
